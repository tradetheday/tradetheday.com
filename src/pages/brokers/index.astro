---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import TrustBadges from '../../components/TrustBadges.astro';
import { brokers as allBrokers } from '../../data/brokers';
import '../../styles/hero-components.css';

// Filter out crypto exchanges - they belong on /exchanges/ page
const brokers = allBrokers.filter(b => b.brokerType !== 'crypto');

const pageTitle = "Best Forex Brokers 2026: Compare Spreads, Fees & Safety";
const pageDescription = "Compare 15+ regulated forex brokers side-by-side. See real spreads, fees, and safety ratings. Find the cheapest broker for your trading style.";

const breadcrumbItems = [
  { text: 'Home', href: '/' },
  { text: 'Brokers', current: true }
];

// Social proof data for brokers (randomized per broker)
const socialProofData: Record<string, number> = {
  'AvaTrade': 324,
  'eToro': 186,
  'Axi': 97,
  'Pepperstone': 213,
  'IC Markets': 178,
  'Plus500': 156,
  'IG': 203,
  'GO Markets': 89,
  'Libertex': 74,
  'City Index': 112,
  'easyMarkets': 67,
  'Vantage': 134,
  'Admiral Markets': 98,
  'Saxo Bank': 145,
  'Eightcap': 87,
  'TitanFX': 76
};
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <!-- Schema.org ItemList markup -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": "Best Trading Brokers 2026",
    "description": pageDescription,
    "numberOfItems": brokers.length,
    "itemListElement": brokers.map((broker, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": broker.name,
      "url": `https://tradetheday.com${broker.reviewUrl}`
    }))
  })} />

  <Fragment slot="breadcrumb">
    <Breadcrumb items={breadcrumbItems} />
  </Fragment>

  <!-- Hero -->
  <section class="hero hero-standard">
    <div class="container">
      <div class="hero-social-proof">
        <span class="social-proof-badge">
          <span class="social-proof-dot"></span>
          2,847 traders compared brokers this month
        </span>
      </div>
      <h1 class="heading-1">Best Trading Brokers 2026</h1>
      <p class="body-large brokers-hero-sub">
        Compare regulated brokers with transparent fees, exclusive bonuses, and honest reviews.
      </p>
      <a href="/find-broker" class="btn btn-primary btn-lg">Find My Perfect Broker ‚Üí Free</a>
      <div class="hero-trust-row">
        <span class="hero-trust-item">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          Tier-1 Regulated Only
        </span>
        <span class="hero-trust-item">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          Unbiased Reviews
        </span>
        <span class="hero-trust-item">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          Exclusive Bonuses
        </span>
      </div>
    </div>
  </section>

  <TrustBadges variant="light" compact={true} />

  <!-- Broker Cards / Table -->
  <section class="section">
    <div class="container">
      <!-- Filter & View Controls Bar -->
      <div class="controls-bar">
        <!-- Sort Options -->
        <div class="sort-controls">
          <label class="sort-label">Sort by:</label>
          <div class="sort-pills">
            <button type="button" class="sort-pill active" data-sort="recommended">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              Recommended
            </button>
            <button type="button" class="sort-pill" data-sort="rating">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              Rating
            </button>
            <button type="button" class="sort-pill" data-sort="min-deposit">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v12m-4-4h8"/></svg>
              Min Deposit
            </button>
            <button type="button" class="sort-pill" data-sort="fees">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              Lowest Fees
            </button>
            <button type="button" class="sort-pill" data-sort="safety">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              Safety
            </button>
          </div>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
          <button type="button" class="view-toggle-btn active" data-view="cards" aria-label="Card view">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7" rx="1"></rect>
              <rect x="14" y="3" width="7" height="7" rx="1"></rect>
              <rect x="3" y="14" width="7" height="7" rx="1"></rect>
              <rect x="14" y="14" width="7" height="7" rx="1"></rect>
            </svg>
            <span class="toggle-label">Cards</span>
          </button>
          <button type="button" class="view-toggle-btn" data-view="table" aria-label="Table view">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="3" y1="15" x2="21" y2="15"></line>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
            <span class="toggle-label">Table</span>
          </button>
          <button type="button" class="view-toggle-btn" data-view="list" aria-label="List view">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <line x1="3" y1="6" x2="3.01" y2="6"></line>
              <line x1="3" y1="12" x2="3.01" y2="12"></line>
              <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
            <span class="toggle-label">List</span>
          </button>
        </div>
      </div>

      <!-- Cards View -->
      <div class="brokers-grid" id="cards-view">
        {brokers.map((broker) => (
          <div
            class={`broker-card ${broker.promoted ? 'broker-card--featured' : ''}`}
            data-rating={broker.scores.overall}
            data-min-deposit={broker.minDeposit}
            data-fees={broker.scores.fees}
            data-safety={broker.scores.safety}
            data-promoted={broker.promoted ? '1' : '0'}
          >
            {broker.promoted && <span class="broker-card-badge">Editor's Choice</span>}

            <!-- Social Proof (Cialdini) -->
            <div class="broker-card-social">
              <span class="social-dot"></span>
              {socialProofData[broker.name] || Math.floor(Math.random() * 150 + 50)} traders matched this week
            </div>

            <div class="broker-card-header">
              <h2 class="broker-card-name">{broker.name}</h2>
              <div class="broker-card-rating">
                <span class="broker-card-score">{broker.scores.overall}</span>
                <span class="broker-card-stars">{'‚òÖ'.repeat(Math.floor(broker.scores.overall))}{'‚òÜ'.repeat(5 - Math.floor(broker.scores.overall))}</span>
              </div>
            </div>

            <p class="broker-card-tagline">{broker.tagline}</p>

            <div class="broker-card-stats">
              <div class="broker-card-stat">
                <span class="broker-card-stat-label">Min Deposit</span>
                <span class="broker-card-stat-value">{broker.minDepositDisplay}</span>
              </div>
              <div class="broker-card-stat">
                <span class="broker-card-stat-label">Spreads From</span>
                <span class="broker-card-stat-value">{broker.spreadsFrom}</span>
              </div>
              <div class="broker-card-stat">
                <span class="broker-card-stat-label">Instruments</span>
                <span class="broker-card-stat-value">{broker.instrumentsDisplay}</span>
              </div>
            </div>

            <div class="broker-card-tags">
              {broker.bestFor.slice(0, 3).map((tag) => (
                <span class="broker-card-tag">{tag}</span>
              ))}
            </div>

            <div class="broker-card-regulation">
              <span class="broker-card-reg-label">Regulated by:</span>
              <span class="broker-card-reg-value">{broker.regulations.map(r => r.authority).join(', ')}</span>
            </div>

            <div class="broker-card-footer">
              {broker.partnerCode && (
                <div class="broker-card-bonus">
                  üéÅ Use code <strong>{broker.partnerCode.code}</strong> for {broker.partnerCode.bonus}
                </div>
              )}

              <div class="broker-card-actions">
                <a href={broker.reviewUrl} class="card-btn card-btn-primary">See Full Analysis</a>
                <a href={broker.affiliateUrl} class="card-btn card-btn-secondary" target="_blank" rel="noopener">Claim Your Bonus ‚Üí</a>
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Table View (Desktop) -->
      <div class="brokers-table-wrapper" id="table-view" style="display: none;">
        <table class="brokers-table">
          <thead>
            <tr>
              <th>Broker</th>
              <th>Rating</th>
              <th>Min Deposit</th>
              <th>Spreads</th>
              <th>Leverage</th>
              <th>Instruments</th>
              <th>Regulators</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {brokers.map((broker) => (
              <tr
                class={broker.promoted ? 'promoted-row' : ''}
                data-rating={broker.scores.overall}
                data-min-deposit={broker.minDeposit}
                data-fees={broker.scores.fees}
                data-safety={broker.scores.safety}
                data-promoted={broker.promoted ? '1' : '0'}
              >
                <td>
                  <div class="table-broker-name">
                    <span class="broker-name-text">{broker.name}</span>
                    {broker.promoted && <span class="table-badge">Editor's Pick</span>}
                  </div>
                </td>
                <td>
                  <div class="table-rating">
                    <span class="table-score">{broker.scores.overall}</span>
                    <span class="table-stars">{'‚òÖ'.repeat(Math.floor(broker.scores.overall))}</span>
                  </div>
                </td>
                <td><span class="table-value">{broker.minDepositDisplay}</span></td>
                <td><span class="table-value">{broker.spreadsFrom}</span></td>
                <td><span class="table-value">{broker.leverage}</span></td>
                <td><span class="table-value">{broker.instrumentsDisplay}</span></td>
                <td>
                  <span class="table-regulators">{broker.regulations.slice(0, 2).map(r => r.authority).join(', ')}{broker.regulations.length > 2 ? '...' : ''}</span>
                </td>
                <td>
                  <div class="table-actions">
                    <a href={broker.reviewUrl} class="table-link">Review</a>
                    <a href={broker.affiliateUrl} class="table-cta" target="_blank" rel="noopener">Visit ‚Üí</a>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        <!-- Mobile Stacked View (shown only on mobile when table view is active) -->
        <div class="brokers-stacked">
          {brokers.map((broker) => (
            <div
              class={`stacked-card ${broker.promoted ? 'stacked-card--featured' : ''}`}
              data-rating={broker.scores.overall}
              data-min-deposit={broker.minDeposit}
              data-fees={broker.scores.fees}
              data-safety={broker.scores.safety}
              data-promoted={broker.promoted ? '1' : '0'}
            >
              <div class="stacked-header">
                <div class="stacked-name-row">
                  <span class="stacked-name">{broker.name}</span>
                  {broker.promoted && <span class="stacked-badge">Editor's Pick</span>}
                </div>
                <div class="stacked-rating">
                  <span class="stacked-score">{broker.scores.overall}</span>
                  <span class="stacked-stars">{'‚òÖ'.repeat(Math.floor(broker.scores.overall))}</span>
                </div>
              </div>

              <div class="stacked-grid">
                <div class="stacked-stat">
                  <span class="stacked-stat-label">Min Deposit</span>
                  <span class="stacked-stat-value">{broker.minDepositDisplay}</span>
                </div>
                <div class="stacked-stat">
                  <span class="stacked-stat-label">Spreads</span>
                  <span class="stacked-stat-value">{broker.spreadsFrom}</span>
                </div>
                <div class="stacked-stat">
                  <span class="stacked-stat-label">Leverage</span>
                  <span class="stacked-stat-value">{broker.leverage}</span>
                </div>
                <div class="stacked-stat">
                  <span class="stacked-stat-label">Instruments</span>
                  <span class="stacked-stat-value">{broker.instrumentsDisplay}</span>
                </div>
              </div>

              <div class="stacked-regulators">
                <span class="stacked-reg-label">Regulated:</span>
                {broker.regulations.slice(0, 3).map(r => r.authority).join(', ')}
              </div>

              <div class="stacked-actions">
                <a href={broker.reviewUrl} class="stacked-link">Full Review</a>
                <a href={broker.affiliateUrl} class="stacked-cta" target="_blank" rel="noopener">Visit Broker ‚Üí</a>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- List View (Simple) -->
      <div class="brokers-list-wrapper" id="list-view" style="display: none;">
        <table class="brokers-list">
          <thead>
            <tr>
              <th>Broker</th>
              <th>Rating</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {brokers.map((broker) => (
              <tr
                data-rating={broker.scores.overall}
                data-min-deposit={broker.minDeposit}
                data-fees={broker.scores.fees}
                data-safety={broker.scores.safety}
                data-promoted={broker.promoted ? '1' : '0'}
              >
                <td>
                  <span class="list-name">{broker.name}</span>
                </td>
                <td>
                  <span class="list-rating">{broker.scores.overall}</span>
                </td>
                <td>
                  <div class="list-actions">
                    <a href={broker.reviewUrl} class="list-link">Review</a>
                    <a href={broker.affiliateUrl} class="list-cta" target="_blank" rel="noopener">Visit</a>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="section section-dark">
    <div class="container text-center">
      <h2 class="heading-2" style="color: var(--white);">Not Sure Which Broker Is Right for You?</h2>
      <p class="body-large" style="color: rgba(255,255,255,0.8); margin-bottom: var(--space-xl);">
        Answer 5 quick questions and our AI will match you with the perfect broker for your trading style. Takes 30 seconds.
      </p>
      <a href="/find-broker" class="btn btn-primary btn-xl">Find My Perfect Broker ‚Üí Free</a>
      <p style="color: rgba(255,255,255,0.5); font-size: var(--font-size-sm); margin-top: var(--space-md);">
        Join 12,847+ traders who found their ideal broker through TradeTheDay
      </p>
    </div>
  </section>
</BaseLayout>

<style>
  /* ===========================================
     BROKERS PAGE - Optimized CSS
     =========================================== */

  /* --- CONTROLS BAR --- */
  .controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
    flex-wrap: wrap;
  }

  .sort-controls {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    flex-wrap: wrap;
    flex: 1;
  }

  .sort-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--gray-600);
    white-space: nowrap;
  }

  .sort-pills {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .sort-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-full);
    background: var(--white);
    color: var(--gray-600);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .sort-pill:hover {
    border-color: var(--gray-300);
    color: var(--charcoal);
    background: var(--gray-50);
  }

  .sort-pill.active {
    border-color: var(--brand-orange);
    background: rgba(255, 72, 0, 0.08);
    color: var(--brand-orange);
  }

  .sort-pill svg {
    opacity: 0.6;
    flex-shrink: 0;
  }

  .sort-pill.active svg {
    opacity: 1;
  }

  /* Grid Layout */
  .brokers-grid {
    display: grid;
    gap: var(--space-lg);
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  }

  /* --- CARD STYLES --- */
  .broker-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-xl);
    padding: var(--space-lg);
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
  .broker-card--featured { border: 2px solid var(--brand-orange); }

  .broker-card-badge,
  .table-badge {
    background: var(--brand-orange);
    color: var(--white);
    padding: 4px 12px;
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-bold);
    text-transform: uppercase;
    white-space: nowrap;
  }
  .broker-card-badge {
    position: absolute;
    top: -12px;
    left: var(--space-md);
  }
  .table-badge {
    font-size: 9px;
    padding: 3px 10px;
    letter-spacing: 0.3px;
    box-shadow: 0 2px 4px rgba(255, 72, 0, 0.3);
  }

  .broker-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
    padding-top: var(--space-xs);
  }
  .broker-card-name { font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); margin: 0; }
  .broker-card-rating { text-align: right; }

  .broker-card-score,
  .table-score {
    font-weight: var(--font-weight-bold);
    color: var(--brand-orange);
  }
  .broker-card-score { display: block; font-size: var(--font-size-xl); line-height: 1; }
  .table-score {
    color: var(--charcoal);
    font-size: var(--font-size-lg);
    background: var(--gray-100);
    padding: 4px 10px;
    border-radius: var(--radius-md);
    min-width: 44px;
    text-align: center;
  }

  .broker-card-stars,
  .table-stars {
    font-size: var(--font-size-xs);
    color: var(--brand-orange);
    line-height: 1;
  }
  .table-stars { font-size: 12px; letter-spacing: -1px; }

  .broker-card-tagline { color: var(--gray-600); font-size: var(--font-size-sm); margin-bottom: var(--space-md); }

  .broker-card-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    padding: var(--space-sm);
    background: var(--gray-50);
    border-radius: var(--radius-md);
  }
  .broker-card-stat { text-align: center; }
  .broker-card-stat-label {
    display: block;
    font-size: 10px;
    color: var(--gray-500);
    text-transform: uppercase;
    margin-bottom: 2px;
  }
  .broker-card-stat-value { font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--charcoal); }

  .broker-card-tags { display: flex; flex-wrap: wrap; gap: var(--space-xs); margin-bottom: var(--space-md); }
  .broker-card-tag {
    background: rgba(255, 72, 0, 0.1);
    color: var(--brand-orange);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
  }

  .broker-card-regulation {
    font-size: var(--font-size-xs);
    color: var(--gray-600);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--gray-100);
  }
  .broker-card-reg-label { font-weight: var(--font-weight-medium); }

  .broker-card-footer {
    margin-top: auto;
    padding-top: var(--space-md);
    width: 100%;
  }
  .broker-card-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    width: 100%;
  }

  .broker-card-actions a,
  .card-btn {
    display: flex !important;
    align-items: center;
    justify-content: center;
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    flex: 1 1 auto;
    padding: var(--space-sm) var(--space-lg) !important;
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    text-decoration: none;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    box-sizing: border-box !important;
    white-space: nowrap;
  }

  .card-btn-primary {
    background: var(--brand-orange);
    color: var(--white);
    border: 1px solid var(--brand-orange);
  }
  .card-btn-primary:hover {
    background: #e04400;
    border-color: #e04400;
    transform: translateY(-2px);
  }

  .card-btn-secondary {
    background: rgba(255, 72, 0, 0.1);
    color: var(--brand-orange);
    border: 1px solid rgba(255, 72, 0, 0.3);
  }
  .card-btn-secondary:hover {
    background: rgba(255, 72, 0, 0.2);
    transform: translateY(-2px);
  }

  .broker-card-bonus {
    width: 100%;
    box-sizing: border-box;
    margin-bottom: var(--space-sm);
    padding: var(--space-sm);
    background: rgba(16, 185, 129, 0.1);
    border-radius: var(--radius-md);
    font-size: var(--font-size-xs);
    color: var(--success);
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .broker-card-social {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 11px;
    color: var(--gray-500);
    padding-bottom: var(--space-sm);
    margin-bottom: var(--space-sm);
    border-bottom: 1px solid var(--gray-100);
  }
  .social-dot {
    width: 6px;
    height: 6px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse-dot 2s infinite;
  }

  /* --- VIEW TOGGLE --- */
  .view-toggle {
    display: inline-flex;
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-full);
    padding: 4px;
    flex-shrink: 0;
  }
  .view-toggle-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    background: transparent;
    color: var(--gray-500);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    border-radius: var(--radius-full);
    cursor: pointer;
    transition: all 0.2s;
  }
  .view-toggle-btn:hover { color: var(--charcoal); background: var(--gray-50); }
  .view-toggle-btn.active { background: var(--charcoal); color: var(--white); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
  .view-toggle-btn.active:hover { background: var(--charcoal); }
  .view-toggle-btn svg { flex-shrink: 0; opacity: 0.7; }
  .view-toggle-btn.active svg { opacity: 1; }
  .toggle-label { display: inline; }

  /* --- TABLE STYLES --- */
  .brokers-table-wrapper {
    /* Break out of container to center on viewport */
    width: 100vw;
    position: relative;
    left: 50%;
    transform: translateX(-50%);
    padding: 0 var(--space-md);
    box-sizing: border-box;
  }

  .brokers-table {
    width: 100%;
    max-width: 1100px;
    margin: 0 auto;
    border-collapse: separate;
    border-spacing: 0;
    font-size: var(--font-size-sm);
    border-radius: var(--radius-xl);
    background: var(--white);
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    border: 1px solid var(--gray-100);
    overflow: hidden;
  }

  /* Mobile stacked view - hidden by default */
  .brokers-stacked {
    display: none;
  }

  .brokers-table thead { background: linear-gradient(180deg, var(--gray-50), var(--gray-100)); }
  .brokers-table th {
    padding: var(--space-md) var(--space-lg);
    text-align: left;
    font-weight: var(--font-weight-bold);
    color: var(--charcoal);
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--gray-200);
    white-space: nowrap;
  }
  .brokers-table th:first-child { padding-left: var(--space-xl); }
  .brokers-table th:last-child { padding-right: var(--space-xl); text-align: right; }

  .brokers-table td {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--gray-100);
    vertical-align: middle;
  }
  .brokers-table td:first-child { padding-left: var(--space-xl); }
  .brokers-table td:last-child { padding-right: var(--space-xl); }
  .brokers-table tbody tr { transition: background 0.2s; }
  .brokers-table tbody tr:last-child td { border-bottom: none; }
  .brokers-table tbody tr:hover { background: var(--gray-50); }

  /* Promoted row */
  .promoted-row {
    background: linear-gradient(90deg, rgba(255,72,0,0.04), rgba(255,72,0,0.02));
  }
  .promoted-row td:first-child {
    position: relative;
  }
  .promoted-row td:first-child::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--brand-orange);
  }
  .promoted-row:hover {
    background: linear-gradient(90deg, rgba(255,72,0,0.08), rgba(255,72,0,0.04));
  }

  /* Table cells */
  .table-broker-name { display: flex; align-items: center; gap: var(--space-sm); min-width: 160px; }
  .broker-name-text { font-weight: var(--font-weight-bold); color: var(--charcoal); }
  .table-rating { display: flex; align-items: center; gap: var(--space-sm); }
  .table-value { font-weight: var(--font-weight-medium); color: var(--charcoal); }
  .table-regulators { color: var(--gray-600); font-size: var(--font-size-xs); max-width: 140px; line-height: 1.4; }

  /* Table actions */
  .table-actions { display: flex; align-items: center; justify-content: flex-end; gap: var(--space-md); }
  .table-link {
    color: var(--gray-500);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    padding: 8px 14px;
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
    transition: all 0.2s;
  }
  .table-link:hover { color: var(--charcoal); border-color: var(--gray-300); background: var(--gray-50); }
  .table-cta {
    background: var(--brand-orange);
    color: var(--white);
    padding: 10px 18px;
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: var(--font-weight-bold);
    white-space: nowrap;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(255,72,0,0.25);
  }
  .table-cta:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,72,0,0.35); }

  /* --- STACKED CARD STYLES (Mobile Table Alternative) --- */
  .stacked-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    margin-bottom: var(--space-sm);
  }

  .stacked-card--featured {
    border: 2px solid var(--brand-orange);
    background: linear-gradient(135deg, rgba(255, 72, 0, 0.02) 0%, transparent 100%);
  }

  .stacked-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--gray-100);
  }

  .stacked-name-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .stacked-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--charcoal);
  }

  .stacked-badge {
    display: inline-block;
    background: var(--brand-orange);
    color: var(--white);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 10px;
    font-weight: var(--font-weight-bold);
    text-transform: uppercase;
    width: fit-content;
  }

  .stacked-rating {
    text-align: right;
  }

  .stacked-score {
    display: block;
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--charcoal);
    line-height: 1;
  }

  .stacked-stars {
    font-size: 12px;
    color: var(--brand-orange);
  }

  .stacked-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
  }

  .stacked-stat {
    background: var(--gray-50);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
  }

  .stacked-stat-label {
    display: block;
    font-size: 10px;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .stacked-stat-value {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--charcoal);
  }

  .stacked-regulators {
    font-size: var(--font-size-xs);
    color: var(--gray-600);
    margin-bottom: var(--space-sm);
  }

  .stacked-reg-label {
    font-weight: var(--font-weight-medium);
    color: var(--gray-500);
  }

  .stacked-actions {
    display: flex;
    gap: var(--space-xs);
  }

  .stacked-link {
    flex: 1;
    padding: 10px;
    text-align: center;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    color: var(--gray-600);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    transition: all 0.2s;
  }

  .stacked-link:hover {
    border-color: var(--gray-300);
    color: var(--charcoal);
  }

  .stacked-cta {
    flex: 2;
    padding: 10px;
    text-align: center;
    background: var(--brand-orange);
    border-radius: var(--radius-md);
    color: var(--white);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-bold);
    text-decoration: none;
    transition: all 0.2s;
  }

  .stacked-cta:hover {
    background: #e04400;
  }

  /* --- LIST VIEW (Simple) --- */
  .brokers-list-wrapper {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
  }

  .brokers-list {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-sm);
    background: var(--white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border: 1px solid var(--gray-200);
  }

  .brokers-list thead {
    background: var(--gray-50);
  }

  .brokers-list th {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--gray-200);
  }

  .brokers-list th:last-child {
    text-align: right;
  }

  .brokers-list td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--gray-100);
    vertical-align: middle;
  }

  .brokers-list tbody tr:last-child td {
    border-bottom: none;
  }

  .brokers-list tbody tr:hover {
    background: var(--gray-50);
  }

  .list-name {
    font-weight: var(--font-weight-semibold);
    color: var(--charcoal);
  }

  .list-rating {
    font-weight: var(--font-weight-bold);
    color: var(--brand-orange);
  }

  .list-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-xs);
  }

  .list-link {
    padding: 6px 12px;
    font-size: var(--font-size-xs);
    color: var(--gray-600);
    text-decoration: none;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-sm);
    transition: all 0.2s;
  }

  .list-link:hover {
    border-color: var(--gray-300);
    color: var(--charcoal);
  }

  .list-cta {
    padding: 6px 12px;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    color: var(--white);
    background: var(--brand-orange);
    text-decoration: none;
    border-radius: var(--radius-sm);
    transition: all 0.2s;
  }

  .list-cta:hover {
    background: #e04400;
  }

  /* --- RESPONSIVE --- */
  @media (max-width: 1100px) {
    .brokers-table th:nth-child(5), .brokers-table td:nth-child(5),
    .brokers-table th:nth-child(6), .brokers-table td:nth-child(6) { display: none; }
  }

  @media (max-width: 900px) {
    .brokers-table th:nth-child(7), .brokers-table td:nth-child(7) { display: none; }

    .controls-bar {
      flex-direction: column;
      gap: var(--space-md);
    }

    .sort-controls {
      width: 100%;
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-sm);
    }

    .sort-pills {
      width: 100%;
      overflow-x: auto;
      flex-wrap: nowrap;
      padding-bottom: var(--space-xs);
      -webkit-overflow-scrolling: touch;
    }

    .view-toggle {
      align-self: flex-end;
    }
  }

  @media (max-width: 768px) {
    /* Hide desktop table, show stacked cards */
    .brokers-table {
      display: none;
    }

    .brokers-stacked {
      display: block;
    }

    .view-toggle-btn {
      padding: 8px 12px;
      font-size: var(--font-size-xs);
    }

    .toggle-label {
      display: none;
    }

    .sort-pill {
      padding: 6px 12px;
      font-size: 11px;
    }

    .sort-pill svg {
      width: 12px;
      height: 12px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- VIEW TOGGLE ---
    const toggleBtns = document.querySelectorAll('.view-toggle-btn');
    const cardsView = document.getElementById('cards-view');
    const tableView = document.getElementById('table-view');
    const listView = document.getElementById('list-view');

    toggleBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;

        // Update button states
        toggleBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Hide all views
        cardsView.style.display = 'none';
        tableView.style.display = 'none';
        listView.style.display = 'none';

        // Show selected view
        if (view === 'cards') {
          cardsView.style.display = 'grid';
        } else if (view === 'table') {
          tableView.style.display = 'block';
        } else if (view === 'list') {
          listView.style.display = 'block';
        }

        // Save preference
        localStorage.setItem('brokers-view', view);
      });
    });

    // Restore saved preference
    const savedView = localStorage.getItem('brokers-view');
    if (savedView === 'table' || savedView === 'list') {
      document.querySelector(`[data-view="${savedView}"]`)?.click();
    }

    // --- SORTING ---
    const sortPills = document.querySelectorAll('.sort-pill');
    const cardItems = document.querySelectorAll('.broker-card');
    const tableRows = document.querySelectorAll('.brokers-table tbody tr');
    const stackedCards = document.querySelectorAll('.stacked-card');
    const listRows = document.querySelectorAll('.brokers-list tbody tr');

    function sortItems(sortType) {
      // Get sorting function based on type
      const getSortValue = (el, type) => {
        switch(type) {
          case 'rating':
            return parseFloat(el.dataset.rating) || 0;
          case 'min-deposit':
            return parseFloat(el.dataset.minDeposit) || 0;
          case 'fees':
            return parseFloat(el.dataset.fees) || 0;
          case 'safety':
            return parseFloat(el.dataset.safety) || 0;
          case 'recommended':
          default:
            // Promoted first, then by rating
            return (el.dataset.promoted === '1' ? 1000 : 0) + (parseFloat(el.dataset.rating) || 0);
        }
      };

      const sortOrder = (type) => {
        // Lower is better for min-deposit, higher is better for others
        return type === 'min-deposit' ? 'asc' : 'desc';
      };

      const order = sortOrder(sortType);

      // Sort cards
      const cardArray = Array.from(cardItems);
      cardArray.sort((a, b) => {
        const aVal = getSortValue(a, sortType);
        const bVal = getSortValue(b, sortType);
        return order === 'asc' ? aVal - bVal : bVal - aVal;
      });
      const cardsGrid = document.getElementById('cards-view');
      cardArray.forEach(card => cardsGrid.appendChild(card));

      // Sort table rows
      const rowArray = Array.from(tableRows);
      rowArray.sort((a, b) => {
        const aVal = getSortValue(a, sortType);
        const bVal = getSortValue(b, sortType);
        return order === 'asc' ? aVal - bVal : bVal - aVal;
      });
      const tbody = document.querySelector('.brokers-table tbody');
      rowArray.forEach(row => tbody.appendChild(row));

      // Sort stacked cards
      const stackedArray = Array.from(stackedCards);
      stackedArray.sort((a, b) => {
        const aVal = getSortValue(a, sortType);
        const bVal = getSortValue(b, sortType);
        return order === 'asc' ? aVal - bVal : bVal - aVal;
      });
      const stackedContainer = document.querySelector('.brokers-stacked');
      stackedArray.forEach(card => stackedContainer.appendChild(card));

      // Sort list rows
      const listArray = Array.from(listRows);
      listArray.sort((a, b) => {
        const aVal = getSortValue(a, sortType);
        const bVal = getSortValue(b, sortType);
        return order === 'asc' ? aVal - bVal : bVal - aVal;
      });
      const listTbody = document.querySelector('.brokers-list tbody');
      listArray.forEach(row => listTbody.appendChild(row));
    }

    sortPills.forEach(pill => {
      pill.addEventListener('click', () => {
        const sortType = pill.dataset.sort;

        // Update active state
        sortPills.forEach(p => p.classList.remove('active'));
        pill.classList.add('active');

        // Sort items
        sortItems(sortType);

        // Save preference
        localStorage.setItem('brokers-sort', sortType);
      });
    });

    // Restore saved sort preference
    const savedSort = localStorage.getItem('brokers-sort');
    if (savedSort) {
      const savedPill = document.querySelector(`[data-sort="${savedSort}"]`);
      if (savedPill) {
        savedPill.click();
      }
    }
  });
</script>
